function HTMLActuator(){this.tileContainer=void 0,this.titleContainer=void 0,this.scoreContainer=void 0,this.bestContainer=void 0,this.score=0}function InputManager(){this.events={},window.navigator.msPointerEnabled?(this.eventTouchstart="MSPointerDown",this.eventTouchmove="MSPointerMove",this.eventTouchend="MSPointerUp"):(this.eventTouchstart="touchstart",this.eventTouchmove="touchmove",this.eventTouchend="touchend")}function LocalStorageManager(){this.bestScoreKey="bestScore",this.gameStateKey="gameState",this.noticeClosedKey="noticeClosed";var a=this.localStorageSupported();this.storage=a?window.localStorage:window.fakeStorage}function Grid(a,b){this.size=a,this.cells=b?this.fromState(b):this.empty()}function Tile(a,b){this.x=a.x,this.y=a.y,this.value=b||2,this.previousPosition=null,this.mergedFrom=null}function GameManager(a,b,c,d){this.size=a,this.inputManager=new b,this.storageManager=new d,this.actuator=new c,this.startTiles=2,this.inputManager.on("move",this.move.bind(this)),this.inputManager.on("restart",this.restart.bind(this)),this.inputManager.on("keepPlaying",this.keepPlaying.bind(this))}!function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),Function.prototype.bind=Function.prototype.bind||function(a){var b=this;return function(c){c instanceof Array||(c=[c]),b.apply(a,c)}},function(){function a(a){this.el=a;for(var b=a.className.replace(/^\s+|\s+$/g,"").split(/\s+/),c=0;c<b.length;c++)d.call(this,b[c])}function b(a,b,c){Object.defineProperty?Object.defineProperty(a,b,{get:c}):a.__defineGetter__(b,c)}if(!("undefined"==typeof window.Element||"classList"in document.documentElement)){var c=Array.prototype,d=c.push,e=c.splice,f=c.join;a.prototype={add:function(a){this.contains(a)||(d.call(this,a),this.el.className=this.toString())},contains:function(a){return-1!=this.el.className.indexOf(a)},item:function(a){return this[a]||null},remove:function(a){if(this.contains(a)){for(var b=0;b<this.length&&this[b]!=a;b++);e.call(this,b,1),this.el.className=this.toString()}},toString:function(){return f.call(this," ")},toggle:function(a){return this.contains(a)?this.remove(a):this.add(a),this.contains(a)}},window.DOMTokenList=a,b(HTMLElement.prototype,"classList",function(){return new a(this)})}}(),HTMLActuator.prototype.setElement=function(a){for(var b in a)this[b+"Container"]=document.querySelector(a[b])},HTMLActuator.prototype.actuate=function(a,b){var c=this;window.requestAnimationFrame(function(){c.clearContainer(c.tileContainer),a.cells.forEach(function(a){a.forEach(function(a){a&&c.addTile(a)})}),c.updateAll(b),b.terminated&&(b.over?c.message(!1):b.won&&c.message(!0))})},HTMLActuator.prototype.setTileHtml=function(a){var b="<div>"+a+"</div>";return a>=1024&&1e4>a&&(a=a.toString().split(""),b="<div>"+a[0]+a[1]+"<br>"+a[2]+a[3]+"</div>"),b},HTMLActuator.prototype.addTile=function(a){var b=this,c=document.createElement("div"),d=document.createElement("div"),e=a.previousPosition||{x:a.x,y:a.y},f=this.positionClass(e),g="tile-"+a.value,h=["tile",g,f];a.value>2048&&h.push("tile-super"),this.applyClasses(c,h),d.classList.add("tile-inner"),d.innerHTML=this.setTileHtml(a.value),a.previousPosition?window.requestAnimationFrame(function(){h[2]=b.positionClass({x:a.x,y:a.y}),b.applyClasses(c,h)}):a.mergedFrom?(h.push("tile-merged"),this.applyClasses(c,h),a.mergedFrom.forEach(function(a){b.addTile(a)})):(h.push("tile-new"),this.applyClasses(c,h)),c.appendChild(d),this.tileContainer.appendChild(c)},HTMLActuator.prototype.applyClasses=function(a,b){a.setAttribute("class",b.join(" "))},HTMLActuator.prototype.normalizePosition=function(a){return{x:a.x+1,y:a.y+1}},HTMLActuator.prototype.positionClass=function(a){return a=this.normalizePosition(a),"tile-position-"+a.x+"-"+a.y},HTMLActuator.prototype.continueGame=function(){this.clearMessage()},HTMLActuator.prototype.clearContainer=function(a){for(a.firstElementChild;a.firstElementChild;)a.removeChild(a.firstElementChild)},HTMLActuator.prototype.updateAll=function(a){var b=this;b.updateScore(a.score),b.updateBestScore(a.bestScore)},HTMLActuator.prototype.updateScore=function(a){this.clearContainer(this.scoreContainer);var b=a-this.score;if(this.score=a,this.scoreContainer.textContent=this.score,b>0){var c=document.createElement("div");c.classList.add("animate-tips"),c.textContent="+"+b,this.scoreContainer.appendChild(c)}},HTMLActuator.prototype.updateBestScore=function(a){this.bestContainer.textContent=a},HTMLActuator.prototype.message=function(a){setTimeout(function(){ev.popup(a?"gamewon":"gameover")},1e3)},HTMLActuator.prototype.clearMessage=function(){ev.closePop()},InputManager.prototype.bind=function(a,b){for(var c=0;c<b.length;c++)this.bindButtonPress(b[c],this[a]);return this},InputManager.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]),this.events[a].push(b)},InputManager.prototype.emit=function(a,b){var c=this.events[a];c&&c.forEach(function(a){a(b)})},InputManager.prototype.listen=function(a){a=document.querySelector(a);var b=this,c={38:0,39:1,40:2,37:3,75:0,76:1,74:2,72:3,87:0,68:1,83:2,65:3};document.addEventListener("keydown",function(a){var d=a.altKey||a.ctrlKey||a.metaKey||a.shiftKey,e=c[a.which];b.targetIsInput(a)||(d||void 0!==e&&(a.preventDefault(),b.emit("move",e)),d||82!==a.which||b.restart.call(b,a))});var d,e;return a.addEventListener(this.eventTouchstart,function(a){!window.navigator.msPointerEnabled&&a.touches.length>1||a.targetTouches>1||b.targetIsInput(a)||(window.navigator.msPointerEnabled?(d=a.pageX,e=a.pageY):(d=a.touches[0].clientX,e=a.touches[0].clientY),a.preventDefault())}),a.addEventListener(this.eventTouchmove,function(a){a.preventDefault()}),a.addEventListener(this.eventTouchend,function(a){if(!(!window.navigator.msPointerEnabled&&a.touches.length>0||a.targetTouches>0||b.targetIsInput(a))){var c,f;window.navigator.msPointerEnabled?(c=a.pageX,f=a.pageY):(c=a.changedTouches[0].clientX,f=a.changedTouches[0].clientY);var g=c-d,h=Math.abs(g),i=f-e,j=Math.abs(i);Math.max(h,j)>10&&b.emit("move",h>j?g>0?1:3:i>0?2:0)}}),this},InputManager.prototype.restart=function(a){a.preventDefault(),this.emit("restart")},InputManager.prototype.keepPlaying=function(a){a.preventDefault(),this.emit("keepPlaying")},InputManager.prototype.bindButtonPress=function(a,b){var c=document.querySelectorAll(a);if(c.length)for(var d=0;d<c.length;d++)c[d].addEventListener("click",b.bind(this)),c[d].addEventListener(this.eventTouchend,b.bind(this))},InputManager.prototype.targetIsInput=function(a){return"input"===a.target.tagName.toLowerCase()},window.fakeStorage={_data:{},setItem:function(a,b){return this._data[a]=String(b)},getItem:function(a){return this._data.hasOwnProperty(a)?this._data[a]:void 0},removeItem:function(a){return delete this._data[a]},clear:function(){return this._data={}}},LocalStorageManager.prototype.localStorageSupported=function(){var a="test",b=window.localStorage;try{return b.setItem(a,"1"),b.removeItem(a),!0}catch(c){return!1}},LocalStorageManager.prototype.getBestScore=function(){return this.storage.getItem(this.bestScoreKey)||0},LocalStorageManager.prototype.setBestScore=function(a){this.storage.setItem(this.bestScoreKey,a)},LocalStorageManager.prototype.getGameState=function(){var a=this.storage.getItem(this.gameStateKey);return a?JSON.parse(a):null},LocalStorageManager.prototype.setGameState=function(a){this.storage.setItem(this.gameStateKey,JSON.stringify(a))},LocalStorageManager.prototype.clearGameState=function(){this.storage.removeItem(this.gameStateKey)},LocalStorageManager.prototype.setNoticeClosed=function(a){this.storage.setItem(this.noticeClosedKey,JSON.stringify(a))},LocalStorageManager.prototype.getNoticeClosed=function(){return JSON.parse(this.storage.getItem(this.noticeClosedKey)||"false")},Grid.prototype.empty=function(){for(var a=[],b=0;b<this.size;b++)for(var c=a[b]=[],d=0;d<this.size;d++)c.push(null);return a},Grid.prototype.fromState=function(a){for(var b=[],c=0;c<this.size;c++)for(var d=b[c]=[],e=0;e<this.size;e++){var f=a[c][e];d.push(f?new Tile(f.position,f.value):null)}return b},Grid.prototype.randomAvailableCell=function(){var a=this.availableCells();return a.length?a[Math.floor(Math.random()*a.length)]:void 0},Grid.prototype.availableCells=function(){var a=[];return this.eachCell(function(b,c,d){d||a.push({x:b,y:c})}),a},Grid.prototype.eachCell=function(a){for(var b=0;b<this.size;b++)for(var c=0;c<this.size;c++)a(b,c,this.cells[b][c])},Grid.prototype.cellsAvailable=function(){return!!this.availableCells().length},Grid.prototype.cellAvailable=function(a){return!this.cellOccupied(a)},Grid.prototype.cellOccupied=function(a){return!!this.cellContent(a)},Grid.prototype.cellContent=function(a){return this.withinBounds(a)?this.cells[a.x][a.y]:null},Grid.prototype.insertTile=function(a){this.cells[a.x][a.y]=a},Grid.prototype.removeTile=function(a){this.cells[a.x][a.y]=null},Grid.prototype.withinBounds=function(a){return a.x>=0&&a.x<this.size&&a.y>=0&&a.y<this.size},Grid.prototype.serialize=function(){for(var a=[],b=0;b<this.size;b++)for(var c=a[b]=[],d=0;d<this.size;d++)c.push(this.cells[b][d]?this.cells[b][d].serialize():null);return{size:this.size,cells:a}},Tile.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},Tile.prototype.updatePosition=function(a){this.x=a.x,this.y=a.y},Tile.prototype.serialize=function(){return{position:{x:this.x,y:this.y},value:this.value}},GameManager.prototype.newNumber=function(){var a=Math.random()<.8?2:4;return a},GameManager.prototype.rules=function(a,b){return a.value===b.value},GameManager.prototype.afterRules=function(a,b){return a.value+b.value},GameManager.prototype.getData=function(){return{value:this.highestValue,score:this.score,bestScore:this.storageManager.getBestScore()-0}},GameManager.prototype.restart=function(){this.storageManager.clearGameState(),this.actuator.continueGame(),this.setup()},GameManager.prototype.keepPlaying=function(){this.keepPlaying=!0,this.actuator.continueGame()},GameManager.prototype.isGameTerminated=function(){return this.over||this.won&&!this.keepPlaying?!0:!1},GameManager.prototype.setup=function(){var a=this.storageManager.getGameState();a?(this.grid=new Grid(a.grid.size,a.grid.cells),this.score=a.score,this.over=a.over,this.won=a.won,this.keepPlaying=a.keepPlaying,this.highestValue=a.highestValue):(this.grid=new Grid(this.size),this.score=0,this.over=!1,this.won=!1,this.keepPlaying=!1,this.highestValue=2,this.addStartTiles()),this.actuate()},GameManager.prototype.addStartTiles=function(){for(var a=0;a<this.startTiles;a++)this.addRandomTile()},GameManager.prototype.addRandomTile=function(){if(this.grid.cellsAvailable()){var a=this.newNumber(),b=new Tile(this.grid.randomAvailableCell(),a);this.grid.insertTile(b)}},GameManager.prototype.actuate=function(){this.storageManager.getBestScore()<this.score&&this.storageManager.setBestScore(this.score),this.over?this.storageManager.clearGameState():this.storageManager.setGameState(this.serialize()),this.actuator.actuate(this.grid,{highestValue:this.highestValue,score:this.score,over:this.over,won:this.won,bestScore:this.storageManager.getBestScore(),terminated:this.isGameTerminated()})},GameManager.prototype.serialize=function(){return{highestValue:this.highestValue,grid:this.grid.serialize(),score:this.score,over:this.over,won:this.won,keepPlaying:this.keepPlaying}},GameManager.prototype.prepareTiles=function(){this.grid.eachCell(function(a,b,c){c&&(c.mergedFrom=null,c.savePosition())})},GameManager.prototype.moveTile=function(a,b){this.grid.cells[a.x][a.y]=null,this.grid.cells[b.x][b.y]=a,a.updatePosition(b)},GameManager.prototype.move=function(a){var b=this;if(!this.isGameTerminated()){var c,d,e=this.getVector(a),f=this.buildTraversals(e),g=!1;this.prepareTiles(),f.x.forEach(function(a){f.y.forEach(function(f){if(c={x:a,y:f},d=b.grid.cellContent(c)){var h=b.findFarthestPosition(c,e),i=b.grid.cellContent(h.next);if(i&&b.rules(d,i)&&!i.mergedFrom){var j=new Tile(h.next,b.afterRules(d,i));j.mergedFrom=[d,i],b.grid.insertTile(j),b.grid.removeTile(d),d.updatePosition(h.next),b.score+=j.value,(!b.highestValue||b.highestValue<j.value)&&(b.highestValue=j.value)}else b.moveTile(d,h.farthest);b.positionsEqual(c,d)||(g=!0)}})}),g&&(this.addRandomTile(),this.movesAvailable()||(this.over=!0),this.actuate())}},GameManager.prototype.getVector=function(a){var b={0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}};return b[a]},GameManager.prototype.buildTraversals=function(a){for(var b={x:[],y:[]},c=0;c<this.size;c++)b.x.push(c),b.y.push(c);return 1===a.x&&(b.x=b.x.reverse()),1===a.y&&(b.y=b.y.reverse()),b},GameManager.prototype.findFarthestPosition=function(a,b){var c;do c=a,a={x:c.x+b.x,y:c.y+b.y};while(this.grid.withinBounds(a)&&this.grid.cellAvailable(a));return{farthest:c,next:a}},GameManager.prototype.movesAvailable=function(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()},GameManager.prototype.tileMatchesAvailable=function(){for(var a,b=this,c=0;c<this.size;c++)for(var d=0;d<this.size;d++)if(a=this.grid.cellContent({x:c,y:d}))for(var e=0;4>e;e++){var f=b.getVector(e),g={x:c+f.x,y:d+f.y},h=b.grid.cellContent(g);if(h&&b.rules(h,a))return!0}return!1},GameManager.prototype.positionsEqual=function(a,b){return a.x===b.x&&a.y===b.y},window.GameCustom=function(a){if(void 0!=a){var b=16384;a.arr=[2,4],a.newNumber=function(){var a=Math.random()<.9?this.arr[0]:this.arr[1];return a},a.rules=function(a,b){var c=!0;return c=a.value===b.value},a.afterRules=function(a,c){var d="";return d=a.value+c.value,d>=b&&(d=b),d},a.actuator.updateAll=function(a){this.updateTitle(a.highestValue),this.updateScore(a.score)};var c;a.actuator.updateTitle=function(d){this.clearContainer(this.titleContainer);var e=["实习生","正式员工","组长","副经理","经理","支行行长","分行行长","总行行长D","总行行长C","总行行长B","总行行长A","总行行长S","总行行长SS"],f=Math.round(Math.log(d)/Math.log(2))-1;d>=b&&(f=e.length-1);var g=this.titleContainer.textContent!=e[f],h=e[f];this.titleContainer.textContent=h;var i=a.title=f>=7?"总行行长":h;if(g){var j=document.createElement("div");if(j.classList.add("animate-tips"),j.textContent=h,this.titleContainer.appendChild(j),f>=4&&7>=f){var k=[i];if(6>=f){var l=6==f?"总行行长":e[f+1];k.push(l)}clearTimeout(c),c=setTimeout(function(){ev.popup("levelup",k)},200)}}ev.setShareData()},a.actuator.message=function(b){b||(clearTimeout(c),ev.gameover(a.score))},a.actuator.setTileHtml=function(a){var b="<div>"+a+"</div>";return b}}},window.ev={ajaxurl:"/bobo/2014-8/msheng/api.php",newElement:function(a){return document.createElement(a)},get:function(a){return document.querySelector(a)},getAll:function(a){return document.querySelectorAll(a)},addEvent:function(a,b,c){a&&a.addEventListener(b,c,!1)},getTitle:function(){return gamer.title||""},popup:function(a,b){this.closePop(),mask.style.display="block";var c="popupbox popup";if(b=b||[],"loading"!=a)for(var d=ev.getAll(".level-title"),e=0;e<d.length;e++)d[e].innerHTML=ev.getTitle();switch(a){case"share":tips_sharefriend.className=c;break;case"levelup":tips_levelup.className=c,ev.get("#level").innerHTML=b[0]||"",b[1]?(ev.get("#level_next").parentElement.style.display="block",ev.get("#level_next").innerHTML=b[1]):ev.get("#level_next").parentElement.style.display="none";break;case"scoresending":send_score.className=c;break;case"gameover":tips_over.className=c,ev.setShareData();break;case"again":tips_again.className=c;break;case"loading":tips_loading.className="popupbox show";break;default:this.closePop()}},closePop:function(){mask.style.display="none",send_score.className=tips_levelup.className=tips_over.className=tips_loading.className=tips_again.className=tips_sharefriend.className="popupbox"},gameover:function(a){function b(a){for(var b=ev.getAll(".mysort"),c=0;c<b.length;c++)b[c].innerHTML=a;ev.popup(a>120?"gameover":"scoresending")}a&&b(10)},setShareData:function(){if(mywx.isWeiXin()){var a=ev.get(".nickname").value||"我",b=ev.get(".avatar-big").faceID,c="http://c.o2omobi.com/case/list/cmbc/img/face"+(10>b?"0"+b:b)+".png",d=document.title,e=a+"已被民生银行聘为"+ev.getTitle()+"，快来挑战吧！";mywx.setData({title:d,link:"http://c.o2omobi.com/case/list/cmbc/",desc:e,img_url:c})}},init:function(){function a(a){var b=h.faceID;b=a?b-1:b+1,0>=b?b=i:b>i&&(b=1),h.style.backgroundImage="url(img/face"+(10>b?"0"+b:b)+".png)",h.faceID=b,ev.setShareData()}function b(){var a=location.href,b={},c="";if(a=a.split("?"),a[1]){a=a[1];for(var d=a.split("&"),e=d.length-1;e>=0;e--)c=d[e].split("="),2==c.length&&(b[c[0].toLowerCase()]=decodeURI(c[1]))}return b}window.gamer=new GameManager(4,InputManager,HTMLActuator,LocalStorageManager),gamer.inputManager.listen(".game-container").bind("restart",["#btn-retry","#btn-again"]),gamer.actuator.setElement({tile:".tile-container",title:".title-container",score:".score-container",best:".best-container"}),"undefined"!=typeof GameCustom&&GameCustom(gamer),this.closePop(),gamer.setup();for(var c=ev.getAll(".action_continue"),d=0;d<c.length;d++)ev.addEvent(c[d],"click",function(){ev.closePop()});var e=ev.getAll(".btn-closer");for(d=0;d<e.length;d++)ev.addEvent(e[d],"click",function(){ev.closePop()});ev.addEvent(ev.get(".nickname"),"blur",function(){ev.setShareData()});var f=/^1[0-9]{10}$/,g=/^([\u4E00-\uFA29]|[\uE7C7-\uE7F3]){2,4}$/;ev.addEvent(btn_send,"click",function(){var a=ev.get("#fullname"),b=ev.get("#telnum"),c=a.value,d=b.value;g.test(c)?f.test(d)?ev.popup("gameover"):alert("请填写正确手机号"):alert("请输入2-4位中文姓名")}),ev.addEvent(ev.get("#btn-resetform"),"click",function(){ev.get("#fullname").value="",ev.get("#telnum").value=""}),ev.addEvent(ev.get("#btn-shareFriend"),"click",function(){ev.popup("share")}),ev.addEvent(ev.get("#btn-share"),"click",function(){ev.popup("share"),ev.setShareData()}),ev.addEvent(ev.get("#btn-popup-again"),"click",function(){ev.popup("again")}),ev.addEvent(tips_sharefriend,"click",function(){ev.closePop()});var h=ev.get(".avatar-big"),i=4;ev.addEvent(ev.get(".btn-prev"),"click",function(){a(!0)}),ev.addEvent(ev.get(".btn-next"),"click",function(){a(!1)});var j=b(),h=ev.get(".avatar-big");2==j.sex?(h.style.backgroundImage="url(img/face03.png)",h.faceID=3):(h.style.backgroundImage="url(img/face01.png)",h.faceID=1),ev.get(".nickname").value=j.nickname||"";var k=1==j.subscribe,l=ev.getAll(".btn-share");ev.get("#btn-atten").style.display=k?"none":"block";for(var m=0;m<l.length;m++)l[m].style.display=k?"block":"none";document.addEventListener("WeixinJSBridgeReady",function(){ev.setShareData()},!1)}};var mask=ev.get("#grey-shadow"),tips_loading=ev.get("#tips-loading"),tips_levelup=ev.get("#tips-levelup"),send_score=ev.get("#send-score"),tips_over=ev.get("#tips-gameover"),tips_sharefriend=ev.get("#sharefriend"),tips_again=ev.get("#tips-again"),btn_send=ev.get("#btn-send");ev.popup("loading");for(var btns_atten=ev.getAll(".btn-atten"),_i=0;_i<btns_atten.length;_i++)btns_atten[_i].href="#";ev.get("#ctn").style.display="block",ev.init();